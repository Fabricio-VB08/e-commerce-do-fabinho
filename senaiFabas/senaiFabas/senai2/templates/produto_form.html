{% extends "base.html" %}

{% block title %}{% if produto %}Editar{% else %}Novo{% endif %} Produto - Vb Store{% endblock %}

{% block content %}
<div class="container">
    <div class="form-header">
        <h1>
            <i class="fas fa-{% if produto %}edit{% else %}plus{% endif %}"></i>
            {% if produto %}Editar Produto{% else %}Adicionar Novo Produto{% endif %}
        </h1>
        <a href="{{ url_for('admin') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar ao Admin
        </a>
    </div>
    
    <div class="form-container">
        <form method="POST" class="product-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="nome">Nome do Produto:</label>
                    <input type="text" id="nome" name="nome" required class="form-input" value="{{ produto.nome if produto else '' }}">
                </div>
                
                <div class="form-group">
                    <label for="categoria">Categoria:</label>
                    <input type="text" id="categoria" name="categoria" required class="form-input" value="{{ produto.categoria if produto else '' }}" list="categorias">
                    <datalist id="categorias">
                        <option value="Eletrônicos">
                        <option value="Roupas">
                        <option value="Calçados">
                        <option value="Livros">
                        <option value="Casa e Jardim">
                        <option value="Esportes">
                        <option value="Beleza">
                        <option value="Brinquedos">
                        <option value="Acessórios">
                        <option value="Decoração">
                    </datalist>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="preco">Preço (R$):</label>
                    <input type="number" id="preco" name="preco" step="0.01" min="0" required class="form-input" value="{{ produto.preco if produto else '' }}">
                </div>
                
                <div class="form-group">
                    <label for="imagem">Imagem do Produto:</label>
                    <div class="image-upload-container">
                        <input type="file" id="file-upload" accept=".png,.jpg,.jpeg,.gif,.webp" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('file-upload').click()">
                            <i class="fas fa-upload"></i> Selecionar Imagem
                        </button>
                        <span id="upload-status"></span>
                    </div>
                    <input type="text" id="imagem" name="imagem" class="form-input" value="{{ produto.imagem if produto else 'produto-default.jpg' }}" placeholder="produto-default.jpg" readonly>
                    <small class="form-help">Insira o nome do arquivo da imagem (ex: produto.jpg) ou faça upload.</small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="descricao">Descrição Detalhada:</label>
                <textarea id="descricao" name="descricao" rows="6" class="form-textarea" placeholder="Descreva o produto em detalhes...">{{ produto.descricao if produto else '' }}</textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> {% if produto %}Salvar Alterações{% else %}Adicionar Produto{% endif %}
                </button>
                
                <a href="{{ url_for('admin') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </form>
        
        <div class="product-preview" {% if not produto %}style="display: none;"{% endif %} id="live-preview">
            <h3>Preview do Produto</h3>
            <div class="preview-card">
                <img src="{{ url_for('static', filename='images/' + (produto.imagem if produto else 'produto-default.jpg')) }}" alt="{{ produto.nome if produto else '' }}" class="preview-image" id="preview-img" onerror="this.src='{{ url_for('static', filename='images/produto-default.jpg') }}'">
                <div class="preview-info">
                    <h4 id="preview-nome">{{ produto.nome if produto else 'Nome do Produto' }}</h4>
                    <p class="preview-category" id="preview-categoria">{{ produto.categoria if produto else 'Categoria' }}</p>
                    <p class="preview-price" id="preview-preco">R$ {{ "%.2f"|format(produto.preco) if produto else '0,00' }}</p>
                    <p class="preview-description" id="preview-descricao">{{ produto.descricao if produto else 'Descrição do produto aparecerá aqui.' }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const isEditing = {{ 'true' if produto else 'false' }};

function updatePreview() {
    const nome = document.getElementById('nome').value;
    const categoria = document.getElementById('categoria').value;
    const preco = document.getElementById('preco').value;
    const imagem = document.getElementById('imagem').value;
    const descricao = document.getElementById('descricao').value;
    
    const previewContainer = document.getElementById('live-preview');
    const imgElement = document.getElementById('preview-img');
    
    if (nome || categoria || preco || descricao || imagem) {
        previewContainer.style.display = 'block';
        document.getElementById('preview-nome').textContent = nome || 'Nome do Produto';
        document.getElementById('preview-categoria').textContent = categoria || 'Categoria';
        document.getElementById('preview-preco').textContent = preco ? `R$ ${parseFloat(preco).toFixed(2).replace('.', ',')}` : 'R$ 0,00';
        document.getElementById('preview-descricao').textContent = descricao || 'Descrição do produto aparecerá aqui.';
        
        if (imagem) {
            imgElement.src = `{{ url_for('static', filename='images/') }}${imagem}`;
            imgElement.onerror = function() {
                this.src = '{{ url_for('static', filename='images/produto-default.jpg') }}';
            };
        } else {
            imgElement.src = '{{ url_for('static', filename='images/produto-default.jpg') }}';
        }
    } else if (!isEditing) {
        previewContainer.style.display = 'none';
    }
}

// Adicionar listeners apenas para o formulário de novo produto
if (!isEditing) {
    ['nome', 'categoria', 'preco', 'imagem', 'descricao'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updatePreview);
        }
    });
}

// Chamar updatePreview na carga inicial para modo de edição
document.addEventListener('DOMContentLoaded', () => {
    if (isEditing) {
        updatePreview(); // Carrega o preview com os dados existentes
    }
});

// Funcionalidade de upload de imagem
document.getElementById('file-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    const uploadStatus = document.getElementById('upload-status');
    uploadStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fazendo upload...';
    uploadStatus.style.color = '#28a745'; // Cor verde para o status de upload
    
    fetch('/upload_imagem', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('imagem').value = data.filename;
            uploadStatus.innerHTML = '<i class="fas fa-check"></i> Upload realizado com sucesso!';
            uploadStatus.style.color = '#28a745';
            
            updatePreview(); // Atualizar preview após upload
            
            setTimeout(() => {
                uploadStatus.innerHTML = '';
            }, 3000);
        } else {
            uploadStatus.innerHTML = '<i class="fas fa-times"></i> ' + data.message;
            uploadStatus.style.color = '#dc3545';
        }
    })
    .catch(error => {
        uploadStatus.innerHTML = '<i class="fas fa-times"></i> Erro no upload';
        uploadStatus.style.color = '#dc3545';
        console.error('Erro:', error);
    });
});

// Permitir edição manual do campo imagem (duplo clique)
document.getElementById('imagem').addEventListener('dblclick', function() {
    this.readOnly = false;
    this.focus();
    this.select(); // Seleciona todo o texto para facilitar a substituição
});

document.getElementById('imagem').addEventListener('blur', function() {
    this.readOnly = true;
    updatePreview(); // Atualiza preview ao sair do campo manual
});

document.getElementById('imagem').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        this.blur();
    }
});
</script>
{% endblock %}